export let activeEffevt = undefined;//æ³¨æ„è¿™ä¸ªå˜é‡æ˜¯ååˆ†åŠ¨æ€çš„ï¼Œååˆ†æ´»è·ƒçš„
function cleanupEffect(effect) {
    const { deps } = effect;
    for (let i = 0; i < deps.length; i++) {
        deps[i].delete(effect);//è§£é™¤effectã€‚é‡æ–°æ”¶é›†ä¾èµ–ï¼Œæ³¨æ„è¿™ä¸ªdeleteæ˜¯setå¯¹è±¡ä¸Šé¢çš„æ–¹æ³•
        //ä¸Šè¿°å¾ªç¯éå†çš„setå…¶å®å°±æ˜¯targetMapé‡Œé¢å¾—åˆ°set
        //æ³¨æ„triggeré‡Œé¢æ˜¯æ ¹æ®targetMapæ¥è§¦å‘çš„
    }
    effect.deps.lenght = 0;//æ³¨æ„è¿™é‡Œåšäº†åŒæ–¹çš„æ¸…ç†å·¥ä½œï¼Œéƒ½æ˜¯å› ä¸ºï¼Œeffectå’Œå¯¹åº”çš„å¯¹è±¡å’Œå±æ€§ï¼Œå­˜åœ¨ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»
}

 export class ReactiveEffect {
    public parent = null;//è¯¥å±æ€§åœ¨å¤„ç†åµŒå¥—å±æ€§çš„æ—¶å€™æå…¶æœ‰ç”¨ï¼› 
    public deps = [];//è®°å½•å±æ€§ï¼Œå’Œtracké…åˆå®ç°å±æ€§å’Œeffectå¤šå¯¹å¤šè®°å½•
    active = true;//è¿™ä¸ªeffecté»˜è®¤æ˜¯æ¿€æ´»çŠ¶æ€
    constructor(public fn, public scheduler) {

    };
    //ä¸å¾—ä¸è¯´ï¼Œä¸‹é¢è¿™ä¸ªrunæ–¹æ³•å®åœ¨æ˜¯å¤ªç²¾è¾Ÿäº†ï¼Œå®ç°äº†æ•°æ®å˜çš„æ—¶å€™ï¼Œå›å»æ¸²æŸ“é¡µé¢ï¼Œè‡³æ­¤ï¼Œå¯¹äºå“åº”å¼çš„åŸç†åˆæ·±å…¥äº†ä¸€æ­¥
    //ç­‰ç­‰ï¼Œæ•°æ®å˜å¾—æ—¶å€™å»æ‰§è¡Œrunæ–¹æ³•ï¼Œæ•°æ®å˜å¾—åŒ–æ˜¯å»å‡ºå‘setã€‚setæ˜¯å±æ€§å’Œä»£ç†å¤„ç†ï¼Œå¦‚ä½•è·å¾—å¯¹åº”çš„effectï¼Ÿä¼°è®¡åˆå†…å­˜ç»“æ„
    //å­˜å‚¨ä»–ä»¬ä¹‹é—´çš„æ˜ å°„å…³ç³»
    //æ‰€ä»¥é‚£ä¸ªé»˜è®¤å…ˆæ‰§è¡Œä¸€æ¬¡runæ–¹æ³•é‡Œé¢å°±å®Œæˆäº†è¿™æ˜ å°„å…³ç³»çš„ç»‘å®šã€‚å¦™å•Š
    run() {
        if (!this.active) {

            //è¿™é‡Œéœ€è¦å°†ä¹‹å‰çš„ä¾èµ–å±æ€§å­—æ®µè¿›è¡Œæ¸…ç©ºï¼Œå› ä¸ºeffectçš„å‡½æ•°é‡Œé¢æ¶‰åŠåˆ°åˆ†æ”¯åˆ‡æ¢ï¼Œå°±æ˜¯ä¿®æ”¹äº†æŸäº›å¸ƒå°”å€¼çš„æ—¶å€™ï¼Œæœ‰äº›å±æ€§ä¸åœ¨ä¾èµ–äº†ï¼Œ
            //æœ‰äº›å±æ€§åˆæˆä¸ºäº†æ–°çš„ä¾èµ–
            cleanupEffect(this);

            this.fn();  //è¿™é‡Œè¡¨ç¤ºå¦‚æœæ˜¯éæ¿€æ´»çš„æƒ…å†µï¼Œåªéœ€è¦æ‰§è¡Œå‡½æ•°ï¼Œä¸éœ€è¦è¿›è¡Œä¾èµ–æ”¶é›†--æœ‰ç‚¹ä¸æ˜ç™½å•Š
            //è¿™é‡Œé¢çš„é€»è¾‘ç°åœ¨æ¥è§¦ä¸åˆ°ï¼Œéœ€è¦åˆ°åé¢å­¦ä¹ åˆ°å¸è½½ç»„ä»¶çš„æ—¶å€™å¯èƒ½ä¼šç”¨åˆ°ï¼Œç°åœ¨å…ˆä¸å»ç®¡å®ƒ
        }
        try {
            //è¿™é‡Œå°±éœ€è¦åšä¾èµ–æ”¶é›†äº†ï¼Œå¦‚ä½•åšï¼Ÿæ ¸å¿ƒå°±æ˜¯å°†å½“å‰çš„effectå’Œç¨åæ¸²æŸ“çš„å±æ€§å…³è”åœ¨ä¸€èµ·
            //æ³¨æ„å•Šï¼Œä¸‹é¢çš„ä»£ç å®åœ¨æ˜¯å¤ªå¦™äº†ï¼Œå¥½å¥½ç†è§£å•Š
            this.parent = activeEffevt;
            activeEffevt = this;
           return  this.fn();//æ­¤å¤„åŠ returnğŸˆ¶ï¸ç‰¹ä¿—æ„ä¹‰ï¼Œæ‰¾äº†æˆ‘å¥½ä¹…ï¼Œæˆ‘ä»–å¦ˆçš„ï¼Œ
           //è¿˜ä¸æ˜¯è¦å®ç°computedï¼Œè·å–effectä¸­å‡½æ•°çš„è¿”å›å€¼ï¼Œå¤ªå‘äº†ï¼Œé«˜äº†æˆ‘å¥½ä¹…
        } finally {
            activeEffevt = this.parent;//å¤„ç†åµŒå¥—effectç”¨çš„
            this.parent = null;
        }
    }
    stop() {
        if (this.active) {
            this.active = false;
            cleanupEffect(this);
        }
    }
}

export function effect(fn, options:any= {}) {
    //fnå¯ä»¥æ ¹æ®çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°æ‰§è¡Œï¼Œå¹¶ä¸”effectå¯ä»¥åµŒå¥—çš„å†™ï¼Œå› ä¸ºç»„ä»¶å°±æ˜¯ä¸€ä¸ªåµŒå¥—çš„ç»“æ„
    const _effect = new ReactiveEffect(fn, options.scheduler);//åˆ›å»ºå“åº”å¼çš„effect
    _effect.run();//é»˜è®¤è¦å…ˆæ‰§è¡Œä¸€æ¬¡

    const runner = _effect.run.bind(_effect);

    runner.effect = _effect;
    return runner;

}
// effect(()=>{
// state.name = "ggrg";
// effect(()=>{
//   state.age = 89;
//})
//state.address = "dgfg"//å¦‚æœæ²¡æœ‰å¤„ç†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„activeEffeft å°†æ˜¯undefined å‡ºç°bug
//})
//å¯¹äºeffectåµŒå¥—çš„æƒ…å†µï¼Œè€ç‰ˆæœ¬çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ ˆæ¥å¤„ç†ï¼Œå…¥æ ˆå‡ºæ ˆï¼Œ
//è‡³äºæ–°ç‰ˆæœ¬ï¼Œå°±æ˜¯ç°åœ¨è¦å­¦ä¹ çš„ï¼Œå±…ç„¶æ˜¯ç»™æ¯ä¸ªeffectè®°å½•å®ƒçš„çˆ¶äº²effectæ˜¯è°ï¼Œå¦‚æ­¤ä¾èµ–ä¸ç”¨å€ŸåŠ©æ ˆï¼Œä¸ç”¨é¢å¤–çš„å­˜å‚¨ç©ºé—´
//å®åœ¨æ˜¯å¤ªå¦™äº†ï¼ï¼ï¼


const targetMap = new WeakMap();//å…¨å±€å¯¹è±¡æ³¨æ„å“¦


export function track(target, type, key) {
    if (!activeEffevt) {//åªæœ‰åœ¨æ¨¡ç‰ˆä¸­ä½¿ç”¨çš„å±æ€§æ‰ä¼šæ”¶é›†ï¼Œå°±æ˜¯æ¨¡ç‰ˆä¸­çš„æ‰ä¼š
        return;
    }//è¿™é‡Œè¿˜æ˜¯å€ŸåŠ©weakMapè¿›è¡Œå­˜å‚¨å…³ç³»ï¼Œ
    //è¿™é‡Œçš„å­˜å‚¨æ–¹å¼æœ‰äº›å¤æ‚ï¼Œä½†æ˜¯ä»”ç»†çœ‹è¿˜æ˜¯å¯ä»¥çœ‹å‡ºæ¥çš„
    //ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¸€ä¸ªæºå¯¹è±¡å¯¹åº”ä¸€ä¸ªmapï¼Œ
    //è¿™ä¸ªmapçš„keyå°±æ˜¯ç¼˜å¯¹è±¡çš„å„ä¸ªå±æ€§ï¼Œè€Œå„ä¸ªå±æ€§åˆå¯ä»¥å¯¹åº”ä¸åŒçš„å±æ€§
    //äºæ˜¯åˆå€ŸåŠ©äº†ä¸€ä¸ªsetç»“æ„ï¼Œ
    //ä¸è¿‡ä¸€ä¸ªå±æ€§å¯¹åº”å¤šä¸ªeffectçš„æƒ…å†µæ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œ
    //éš¾ä¸æˆä¸€ä¸ªå¯¹è±¡å¤šä¸ªç»„ä»¶æ¥ç”¨å—ï¼Ÿä¹Ÿè®¸å§
    let depsMap = targetMap.get(target);//è¿™ä¸ªå˜é‡å°±æ˜¯å­˜å‚¨å„ä¸ªå±æ€§å¯¹åº”çš„effectçš„mao
    if (!depsMap) {
        targetMap.set(target, (depsMap = new Map()))
    }
    let dep = depsMap.get(key);//æ­¤depå°±æ˜¯å­˜å‚¨å•ä¸ªå±æ€§çš„effectçš„set
    if (!dep) {
        depsMap.set(key, (dep = new Set()))
    }
    //ç”±äºä¸‹é¢è¿™éƒ¨åˆ†ä»£ç åœ¨sç®—å±æ€§çš„é‡Œé¢ä¹Ÿä¼šç”¨åˆ°ï¼Œ æ‰€ä»¥æŠ½ç¦»å‡ºæ¥ï¼Œç²¾ç®€ä»£ç ï¼›
    trackEffects(dep)
  
}
export function trackEffects(dep){
    let shouldTrack = !dep.has(activeEffevt);
    if (shouldTrack) {
        dep.add(activeEffevt);
        activeEffevt.deps.push(dep)//æ„Ÿè§‰è¿™é‡Œæœ‰ç‚¹é—®é¢˜
    }
}
//å§æ§½ ä¸Šé¢åªæ˜¯å•å‘è®°å½•ï¼Œå±æ€§è®°å½•çš„effectï¼Œéš¾ä¸æˆeffectä¹Ÿéœ€è¦è®°å½•å±æ€§ï¼Ÿ
//åå‘è®°å½•æ˜¯ä¸ºäº†æ–¹ä¾¿æ¸…ç†å“¦
//æœ‰traceå°±è¦æœ‰triggerã€‚æ”¶é›†äº†ä¾èµ–ï¼Œå°±è¦ä½¿ç”¨ï¼Œä¸ç„¶æ”¶é›†å®ƒå¹²å˜›
export function trigger(target, type, key, value, oldValue) {
    const depsMap = targetMap.get(target);
    if (!depsMap) { return; }//
    let effects = depsMap.get(key);//æ‹¿åˆ°å±æ€§å¯¹åº”çš„effecté›†åˆset
    //è¿™é‡Œç›´æ¥å¾ªç¯effectæ®è¯´ä¼šæœ‰é”™è¯¯ï¼Œå°±æ˜¯ä¸æ–­çš„å¾ªç¯
    //ä½†æ˜¯æˆ‘æ²¡æœ‰é‡åˆ°è¿™æƒ…å†µå‘€
    //è¿˜è¦æ‹·è´ä¸€ä¸ªsetè¿›è¡Œå¾ªç¯
    //çœŸçš„é†‰äº†
    if (effects) {
        //åŒç†ï¼Œä¸‹é¢ä»£ç ä¹Ÿè¦æŠ½ç¦»å‡ºæ¥ï¼Œå› ä¸ºè®¡ç®—å±æ€§è¦ç”¨çš„åˆ°
      triggerEffects(effects)
    }

}
export function triggerEffects(effects){
    effects = new Set(effects);
    effects.forEach(effect => {
        // effect.run();
        if (effect !== activeEffevt) {

            if (effect.schduler) {

                debugger;
                effect.schduler();//æä¾›è°ƒåº¦æ–¹æ³•ï¼Œå¦‚æœç”¨æˆ·ä¼ å…¥scheduleræ–¹æ³•ï¼Œåˆ™è°ƒç”¨è¿™ä¸ªæ–¹æ³•
            } else { effect.run(); }
        }//è¿™è¾¹å…¶å®æ˜¯å¤„ç†effectä¸­æœ‰å‡ºå‘setæ“ä½œçš„ä»£ç çš„ï¼Œè™½ç„¶è¿™ç§æƒ…å†µå¾ˆå°‘
        //å‡ºç°ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦é¢„é˜²ï¼Œæƒ³è±¡ï¼Œeffecté‡Œé¢æœ‰setæ“ä½œï¼Œè§¦å‘triggeræ–¹æ³•ï¼Œtriggeræ–¹æ³•åˆrunï¼Œç„¶ååˆæ˜¯ï¼Œå°±æ˜¯å¾ªç¯äº†
    });
}  